<!DOCTYPE html>
<html>
  <head>
    <title>Demo</title>
    <link rel="stylesheet" href="https://unpkg.com/@glorious/demo/dist/gdemo.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs/themes/prism-tomorrow.css">
  </head>
  <body>
    

    <div id="container"></div>
   
    <script src="https://unpkg.com/@glorious/demo/dist/gdemo.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs"></script>
    
    <script>

      // Constructor receives a selector that indicates
    // where to inject the demonstration in your page.
    const demo = new GDemo('#container');

const code = `
S = cov  #Cov matrix (S)
A = 1.2  #Risk-aversion (A)

#Implied Equilibrium Excess Returns (pi):
    #pi = 2A*S*w -> Meucci
pi = 2.0*A*np.dot(S, mcs_w)

#Views Vector (Q): ESG scores
Q = stock_scores.Total.values

#Link Matrix (P):
P = np.zeros((34,34))
np.fill_diagonal(P, 1)

#Scalar (tau), c, and Uncertainty of views matrix (omega):
    #tau = 1 / length of time series --> Meucci
    #c = 1 --> Meucci
    #omega = 1/c*P*S*P^T --> Meucci
tau = 1.0 / float(len(port))
c = 1.0
omega = np.dot(np.dot(P, S), P.T) / c

## BL Excess Returns:
    # = pi + tau*S*P^T * (tau*P*S*P^T + omega)^-1 * (Q - P*pi)
post_pi = pi + np.dot(np.dot(tau*np.dot(S, P.T), 
          np.linalg.inv(tau*np.dot(np.dot(P, S), P.T) + omega)), 
          (Q - np.dot(P, pi)))

# BL Covariance Matrix:
    # = (1+tau)*S - tau^2*S*P.T * (tau*P*S*P.T + omega)^-1 * P*S
post_S = (1.0+tau)*S - np.dot(np.dot(tau**2.0*np.dot(S, P.T), 
        np.linalg.inv(np.dot(tau*np.dot(P, S), P.T) + omega)), np.dot(P, S))

symS = (post_S + post_S.T) / 2   #Make it symmetric
semidefS = cov_nearest(symS)     #Ensure strict positive semi-definite

SD = pd.DataFrame(semidefS)
print(tabulate(SD, headers = ["Covariance Matrix for Risk"]))    #Adjusted covariance matrix to calculate risk

#Defining variables to be used as NumPy arrays for dot product operations:
ret = stock_scores.Returns.values  
esg = stock_scores.Total.values
e_esg = stock_scores.Environmental.values
s_esg = stock_scores.Social.values
g_esg = stock_scores.Governance.values

# Optimization Function:
def opt():
  '''
  fun: Black-Lit. method
  returns: array of optimal weights for given method.
  '''
  #Set Variables needed for optimization:
  w = cp.Variable(len(ret))             #List of weights
  rating = w@esg                        #ESG rating of portfolio
  e_rating = w@e_esg                    #Environmental rating
  s_rating = w@s_esg                    #Social rating
  g_rating = w@g_esg                    #Governance rating
  risk = cp.quad_form(w, cov)           #Volatility 

  risk_bl = cp.quad_form(w, semidefS)       #New Risk Term
  obj = cp.Minimize(risk_bl - A*post_pi@w)  #Obj. Funct. With BL returns
  cons = [cp.sum(w)==1, w>=0, w<=0.15]      #Constraints

  #Solve optimization:
  prob = cp.Problem(obj, cons)
  prob.solve(solver=cp.ECOS)

  return w.value.round(3)  #Return array of optimal weights

#Methods optimized:
m_1 =  opt()
M = pd.DataFrame(m_1, index = stocks)
print(tabulate(M, headers = ["Stock", "Weight"]))
`
const response = `
Covariance Matrix for Risk
--  ------------  -----------  -----------  -----------  -----------  ------------  -----------  ------------  -----------  -----------  ------------  -----------  ------------ 
 ------------  ------------  ------------  -----------  ------------  ------------  ------------  ------------  -----------  -----------  ------------  ------------  -----------  -----------  -----------  ------------  ------------  -----------  -----------  ------------  ----------------------------
 0   0.0018999    0.000227869  0.000117087  0.000321015  0.000104796   0.000354025  8.43294e-05   0.00111058   0.000240111  9.3986e-05    0.000267791  0.000401247   0.000941786 
  0.00059826    0.000423172   0.000531699  0.000387406   0.000333444   0.000532863   0.00121843    0.000309354  0.000247604  0.000405326   0.000795278   0.000524193  0.000341811  0.000295156  0.000101801  -0.000116479   0.000188303  0.000117993  0.000386114   0.00153759                    0.000632888
 1   0.000227869  0.000462563  0.000199659  0.000303487  0.000156412   0.00016667   0.000198949   0.000220594  0.000406362  0.00026093    0.000165406  0.000205382   0.000310273 
  0.000237142   0.000175982   0.000254613  0.000277635   0.000239523   0.000216624   0.000225714   0.000240836  0.000166238  0.000211198   0.000245655   0.000248816  0.00018245 
  0.00027919   0.000131821   7.93302e-05   0.000134525  0.000128463  0.000399995   0.000255806                   0.000216697
 2   0.000117087  0.000199659  0.000313352  0.000202161  0.000161861   0.000131787  0.000161237   0.000130571  0.000235676  0.000128923   0.000118752  0.000186478   0.000183674 
  0.000177996   0.000153459   0.000176665  0.000182976   0.000197686   0.000165936   0.000120051   0.000159997  0.000153105  0.000180892   9.63248e-05   0.000157437  0.000148279  0.000226124  0.000153814   0.000143857   0.000137973  0.000140762  0.000182568   0.000103491                   0.000159048
 3   0.000321015  0.000303487  0.000202161  0.000539724  0.000156739   0.000235754  0.000143232   0.000330819  0.000437423  0.000210573   0.000220997  0.000255826   0.000374661 
  0.000328521   0.000254736   0.000313316  0.000317081   0.000298982   0.000322723   0.000308206   0.00027937   0.000185745  0.000250017   0.000420288   0.000315588  0.00023117 
  0.0003104    0.000130966   4.7193e-05    0.000132207  0.000123377  0.000397156   0.000374931                   0.00031064
 4   0.000104796  0.000156412  0.000161861  0.000156739  0.00031541    0.000164277  0.000122155   0.000179989  0.000143313  8.27129e-05   0.000107305  0.000191313   0.000224931 
  0.000186457   0.000152997   0.000198937  0.000179728   0.000195904   0.000168861   0.000138043   0.000177059  0.000149504  0.000198347   9.19829e-05   0.000158931  0.00016527 
  0.000197947  0.000124547   5.23809e-05   0.000176121  0.000140931  9.63291e-05   0.000133535                   0.000209589
 5   0.000354025  0.00016667   0.000131787  0.000235754  0.000164277   0.000411203  8.83628e-05   0.00037611   0.000187612  9.23506e-05   0.000178913  0.000205172   0.000405702 
  0.000319463   0.000269092   0.000286666  0.00023514    0.000227446   0.000302945   0.000334485   0.000272068  0.000153022  0.000206525   0.000381309   0.000279563  0.00020048 
  0.000242938  0.000139622  -6.77087e-05   0.000180085  0.000109094  0.000197663   0.000450829                   0.000331822
 6   8.43294e-05  0.000198949  0.000161237  0.000143232  0.000122155   8.83628e-05  0.000339117   9.5159e-05   0.000230678  0.00015791    9.40541e-05  0.000112041   0.000118668 
  0.000115699   9.87352e-05   0.000125803  0.000167065   0.000137735   7.96936e-05   6.9104e-05    0.000110629  0.000100348  0.000124051   8.5339e-05    0.000106749  0.000133448  0.000169158  9.60196e-05   0.000144718   0.000119406  0.000101769  0.0001728     5.02105e-05                   0.000108463
 7   0.00111058   0.000220594  0.000130571  0.000330819  0.000179989   0.00037611   9.5159e-05    0.00109376   0.000221139  9.58444e-05   0.000253467  0.000373887   0.000836051 
  0.000538614   0.000414885   0.000523586  0.000412249   0.000330815   0.000501495   0.000956231   0.000357112  0.000241229  0.000370247   0.000739189   0.000472817  0.000339513  0.000301195  0.000134068  -0.000174531   0.000227402  0.000150132  0.000335643   0.00118658                    0.000574896
 8   0.000240111  0.000406362  0.000235676  0.000437423  0.000143313   0.000187612  0.000230678   0.000221139  0.00111746   0.000339068   0.000167052  0.000231044   0.000319558 
  0.000250836   0.000191035   0.00026688   0.000312215   0.000268755   0.000264653   0.000228098   0.000273     0.000190738  0.00024408    0.000311904   0.000266139  0.000204926  0.000342645  0.000141094   0.000269209   0.000128747  0.000155129  0.000545109   0.000261796                   0.000222748
 9   9.3986e-05   0.00026093   0.000128923  0.000210573  8.27129e-05   9.23506e-05  0.00015791    9.58444e-05  0.000339068  0.000342951   8.60244e-05  9.3934e-05    0.000152714 
  0.000111288   8.60385e-05   0.000131089  0.000167831   0.000139505   9.11891e-05   8.64113e-05   0.000141102  9.37808e-05  0.000103463   0.000117181   0.000133983  0.00011378 
  0.000178028  7.73653e-05   4.97473e-05   7.52616e-05  6.97391e-05  0.000313181   9.77498e-05                   9.78281e-05
10   0.000267791  0.000165406  0.000118752  0.000220997  0.000107305   0.000178913  9.40541e-05   0.000253467  0.000167052  8.60244e-05   0.000379181  0.000214954   0.000278336 
  0.000247933   0.000208316   0.000251053  0.000216191   0.000179947   0.00020446    0.000260793   0.000218002  0.000179938  0.000175733   0.000264161   0.000230364  0.000172098  0.000168882  9.52237e-05  -2.37989e-05   0.000121301  8.26134e-05  0.000154221   0.000290424                   0.000249139
11   0.000401247  0.000205382  0.000186478  0.000255826  0.000191313   0.000205172  0.000112041   0.000373887  0.000231044  9.3934e-05    0.000214954  0.000452245   0.000366579 
  0.000342467   0.000267602   0.000351583  0.000255852   0.000255231   0.000295549   0.000328398   0.000238043  0.000192751  0.000309693   0.00032198    0.000290066  0.000228047  0.000254406  0.000144211   1.14135e-05   0.000180012  0.000139485  0.000209078   0.000373501                   0.000344055
12   0.000941786  0.000310273  0.000183674  0.000374661  0.000224931   0.000405702  0.000118668   0.000836051  0.000319558  0.000152714   0.000278336  0.000366579   0.00129531  
  0.000540917   0.000424883   0.000538927  0.000452248   0.000392919   0.000559716   0.000877487   0.000450568  0.000262375  0.000360011   0.000846398   0.000497585  0.000351387  0.000371209  0.000152429  -4.12693e-05   0.000273169  0.000182162  0.000465188   0.00109059                    0.000580363
13   0.00059826   0.000237142  0.000177996  0.000328521  0.000186457   0.000319463  0.000115699   0.000538614  0.000250836  0.000111288   0.000247933  0.000342467   0.000540917 
  0.000612828   0.000444031   0.000443649  0.000348176   0.000319327   0.00045004    0.000508577   0.000249277  0.00022542   0.000326802   0.000648016   0.000489088  0.000297813  0.000295927  0.000156502  -5.53978e-05   0.000207574  0.00016055   0.000258416   0.000623957                   0.000566851
14   0.000423172  0.000175982  0.000153459  0.000254736  0.000152997   0.000269092  9.87352e-05   0.000414885  0.000191035  8.60385e-05   0.000208316  0.000267602   0.000424883 
  0.000444031   0.000469504   0.000352809  0.000282289   0.000237077   0.000355636   0.000397841   0.000206802  0.000202927  0.000254357   0.000497531   0.000372902  0.000242126  0.000231859  0.000139167  -6.77796e-05   0.000173531  0.000138406  0.000202157   0.000477933                   0.000418818
15   0.000531699  0.000254613  0.000176665  0.000313316  0.000198937   0.000286666  0.000125803   0.000523586  0.00026688   0.000131089   0.000251053  0.000351583   0.000538927 
  0.000443649   0.000352809   0.000683115  0.000374025   0.000314041   0.000403941   0.000491191   0.000342861  0.000211748  0.000341485   0.000602586   0.000387943  0.000269074  0.000298151  0.000156102  -3.3044e-05    0.000192607  0.000138552  0.000280619   0.000571839                   0.000431296
Stock      Weight
-------  --------
AMZN         0
IBM          0
TSLA         0
AAL          0
UAL          0
DAL          0
MRK          0
MRNA         0
PFE          0
GS           0
BAC          0
ECL          0.15
WFC          0.15
CVX          0
BK           0.15
CDW          0.15
CTSH         0.15
MCO          0.1
NOC          0.15
AAPL         0
ABT          0
AEE          0
FANG         0
ALK          0
ADI          0
AIZ          0
AKAM         0
AMD          0
AOS          0
BA           0
AVY          0
CBRE         0
DHI          0
DVA          0
`
const highlightedCode = Prism.highlight(
  code,
  Prism.languages.javascript,
  'javascript'
);

demo
  .openApp('editor', {minHeight: '350px', windowTitle: 'demo.js', initialContent : highlightedCode})
  .write( '', {onCompleteDelay: 5000})
  .openApp('terminal', {minHeight: '350px', promptString: '$'})
  .command('node ./part3', {onCompleteDelay: 5000})
  .respond(response)
  .command('')
  .end();

    </script>
  </body>
</html>